<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Online Voting System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff6b6b;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background-color: #51cf66;
        }
        
        .total-votes {
            font-weight: 600;
            color: #495057;
        }
        
        .candidates-container {
            display: grid;
            gap: 20px;
        }
        
        .candidate {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .candidate:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .candidate-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 20px;
        }
        
        .candidate-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e9ecef;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .candidate-photo:hover {
            transform: scale(1.05);
        }
        
        .candidate-content {
            flex: 1;
        }
        
        .candidate-details h3 {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 5px;
        }
        
        .candidate-description {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .vote-stats {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .vote-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: #495057;
        }
        
        .vote-percentage {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: 600;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .vote-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .vote-btn {
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(81, 207, 102, 0.3);
        }
        
        .vote-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(81, 207, 102, 0.4);
        }
        
        .vote-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .voted-indicator {
            background: linear-gradient(45deg, #ffd43b, #fab005);
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.1rem;
        }
        
        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .success {
            background: #51cf66;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .candidate-info {
                flex-direction: row;
                align-items: flex-start;
                gap: 15px;
            }
            
            .candidate-photo {
                width: 60px;
                height: 60px;
            }
            
            .vote-stats {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó≥Ô∏è Real-Time Voting System</h1>
        <p class="subtitle">Cast your vote and watch results update live!</p>
    </div>

    <div class="status-bar">
        <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="connectionText">Connecting...</span>
        </div>
        <div class="total-votes">
            Total Votes: <span id="totalVotes">0</span>
        </div>
    </div>

    <div id="messageContainer"></div>
    
    <div id="loadingMessage" class="loading">
        üîÑ Loading candidates...
    </div>
    
    <div id="candidatesContainer" class="candidates-container" style="display: none;">
        <!-- Candidates will be loaded here -->
    </div>

    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        class VotingSystem {
            constructor() {
                this.socket = null;
                this.sessionId = localStorage.getItem('voting-session-id') || null;
                this.hasVoted = false;
                this.votedFor = null;
                this.candidates = [];
                
                this.init();
            }

            init() {
                this.setupSocketConnection();
                this.loadInitialData();
            }

            setupSocketConnection() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    console.log('Connected to server');
                    this.updateConnectionStatus(true);
                });
                
                this.socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                    this.updateConnectionStatus(false);
                });
                
                this.socket.on('vote-update', (stats) => {
                    console.log('Received vote update:', stats);
                    this.updateCandidateStats(stats);
                });
                
                this.socket.on('connect_error', (error) => {
                    console.error('Connection error:', error);
                    this.showMessage('Connection error. Please refresh the page.', 'error');
                });
            }

            updateConnectionStatus(connected) {
                const statusDot = document.getElementById('statusDot');
                const connectionText = document.getElementById('connectionText');
                
                if (connected) {
                    statusDot.classList.add('connected');
                    connectionText.textContent = 'Connected';
                } else {
                    statusDot.classList.remove('connected');
                    connectionText.textContent = 'Disconnected';
                }
            }

            async loadInitialData() {
                try {
                    // Check vote status first
                    const voteStatus = await this.fetchWithSession('/api/vote-status');
                    this.sessionId = voteStatus.sessionId;
                    this.hasVoted = voteStatus.hasVoted;
                    this.votedFor = voteStatus.votedFor;
                    
                    // Store session ID
                    localStorage.setItem('voting-session-id', this.sessionId);
                    
                    // Load candidates and stats
                    const data = await this.fetchAPI('/api/votes');
                    this.candidates = data.candidates;
                    
                    this.renderCandidates(data.candidates);
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('candidatesContainer').style.display = 'block';
                    
                } catch (error) {
                    console.error('Error loading initial data:', error);
                    this.showMessage('Failed to load voting data. Please refresh the page.', 'error');
                }
            }

            async fetchAPI(url, options = {}) {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            }

            async fetchWithSession(url, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (this.sessionId) {
                    headers['X-Session-ID'] = this.sessionId;
                }
                
                const response = await fetch(url, {
                    ...options,
                    headers
                });
                
                // Update session ID if provided in response
                const newSessionId = response.headers.get('X-Session-ID');
                if (newSessionId) {
                    this.sessionId = newSessionId;
                    localStorage.setItem('voting-session-id', newSessionId);
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            }

            renderCandidates(candidates) {
                const container = document.getElementById('candidatesContainer');
                const totalVotes = candidates.reduce((sum, candidate) => sum + candidate.votes, 0);
                
                // Calculate percentages
                const candidatesWithPercentage = candidates.map(candidate => ({
                    ...candidate,
                    percentage: totalVotes > 0 ? Math.round((candidate.votes / totalVotes) * 100) : 0
                }));
                
                document.getElementById('totalVotes').textContent = totalVotes;
                
                container.innerHTML = candidatesWithPercentage.map(candidate => `
                    <div class="candidate" data-id="${candidate.id}">
                        <div class="candidate-info">
                            <img src="${candidate.photo}" alt="${candidate.name}" class="candidate-photo" 
                                 onerror="this.src='https://via.placeholder.com/80x80/cccccc/white?text=${candidate.name.split(' ').map(n => n[0]).join('')}'">
                            <div class="candidate-content">
                                <div class="candidate-details">
                                    <h3>${candidate.name}</h3>
                                    <div class="vote-stats">
                                        <span class="vote-count">${candidate.votes}</span>
                                        <span class="vote-percentage">${candidate.percentage}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${candidate.description ? `<div class="candidate-description">${candidate.description}</div>` : ''}
                        
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${candidate.percentage}%"></div>
                        </div>
                        
                        <div class="vote-actions">
                            ${this.hasVoted ? (
                                this.votedFor === candidate.id ? 
                                    '<div class="voted-indicator">‚úì Your Vote</div>' : 
                                    '<button class="vote-btn" disabled>Vote</button>'
                            ) : `<button class="vote-btn" onclick="votingSystem.vote(${candidate.id})">Vote for ${candidate.name}</button>`}
                        </div>
                    </div>
                `).join('');
            }

            updateCandidateStats(stats) {
                const totalVotes = stats.reduce((sum, candidate) => sum + candidate.votes, 0);
                document.getElementById('totalVotes').textContent = totalVotes;
                
                stats.forEach(candidate => {
                    const candidateElement = document.querySelector(`[data-id="${candidate.id}"]`);
                    if (candidateElement) {
                        const voteCount = candidateElement.querySelector('.vote-count');
                        const percentage = candidateElement.querySelector('.vote-percentage');
                        const progressFill = candidateElement.querySelector('.progress-fill');
                        
                        if (voteCount) voteCount.textContent = candidate.votes;
                        if (percentage) percentage.textContent = `${candidate.percentage}%`;
                        if (progressFill) progressFill.style.width = `${candidate.percentage}%`;
                    }
                });
            }

            async vote(candidateId) {
                if (this.hasVoted) {
                    this.showMessage('You have already voted!', 'error');
                    return;
                }

                try {
                    const result = await this.fetchWithSession('/api/vote', {
                        method: 'POST',
                        body: JSON.stringify({ candidateId })
                    });

                    this.hasVoted = true;
                    this.votedFor = candidateId;
                    
                    const candidate = this.candidates.find(c => c.id === candidateId);
                    this.showMessage(`‚úÖ Vote recorded successfully for ${candidate ? candidate.name : 'candidate'}!`, 'success');
                    
                    // Re-render to show voted state
                    const data = await this.fetchAPI('/api/votes');
                    this.renderCandidates(data.candidates);
                    
                } catch (error) {
                    console.error('Error voting:', error);
                    this.showMessage(`‚ùå ${error.message}`, 'error');
                }
            }

            showMessage(message, type = 'info') {
                const container = document.getElementById('messageContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = type;
                messageDiv.textContent = message;
                
                container.appendChild(messageDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 5000);
            }
        }

        // Initialize the voting system when page loads
        let votingSystem;
        document.addEventListener('DOMContentLoaded', () => {
            votingSystem = new VotingSystem();
        });
    </script>
</body>
</html>